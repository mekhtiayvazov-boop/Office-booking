<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Бронирование мест</title>
<style>
body { font-family: Arial; background:#f4f6f8; padding:30px; }
select, input, button { padding:8px; width:300px; margin:5px 0; }
table { margin-top:20px; width:100%; border-collapse:collapse; background:#fff; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#eee; }
.cancel { color:red; cursor:pointer; }
#office-map { display:grid; grid-template-columns:repeat(5,120px); grid-gap:10px; margin-top:20px; }
.seat { border-radius:8px; display:flex; justify-content:space-between; flex-direction:column; cursor:pointer; user-select:none; padding:5px; background:#eaeaea; }
.seat-name { text-align:center; font-weight:bold; margin-bottom:3px; }
.day-block { flex:1; margin:1px 0; border-radius:4px; color:white; font-size:10px; display:flex; align-items:center; justify-content:center; transition: transform .1s; }
.day-block.available { background:#28a745; }
.day-block.taken { background:#dc3545; }
.day-block.current-day { background:#ffc107; }
.day-block:hover { transform: scale(1.1); }
#week-nav { display: flex; justify-content: space-between; margin-bottom: 20px; }
#week-nav button { padding: 10px; }
</style>
</head>
<body>

<h2>Бронирование мест</h2>

<select id="employee"></select><br>
<select id="seat"></select><br>

<label>Выберите дату (Понедельник для недели):</label><br>
<input type="date" id="date"><br>

<label>
<input type="checkbox" id="weekBooking"> Бронирование на всю рабочую неделю (Пн–Пт)
</label><br>

<button onclick="book()">Забронировать</button>

<h2>Текущая неделя</h2>
<div id="week-nav">
  <button onclick="changeWeek(-1)">◀ Пред. неделя</button>
  <button onclick="changeWeek(1)">След. неделя ▶</button>
</div>

<h2>Схема офиса</h2>
<div id="office-map"></div>

<table>
<thead>
<tr>
<th>Место</th>
<th>Сотрудник</th>
<th>Дата</th>
<th>День недели</th>
<th></th>
</tr>
</thead>
<tbody id="table"></tbody>
</table>

<script>
const seats = ["4D26","4D27","4D28","4D31","4D32","4D33","4D34","4E29","4E30","4E32","4E33","4E34","4EX1","4EX2","4EX3"];
const employees = Array.from({length: 22}, (_, i) => `Сотрудник ${i + 1}`);
const WORK_DAYS = ["Понедельник","Вторник","Среда","Четверг","Пятница"];

const emp = document.getElementById("employee");
const seat = document.getElementById("seat");
employees.forEach(e => emp.add(new Option(e,e)));
seats.forEach(s => seat.add(new Option(s,s)));

// Устанавливаем сегодняшнюю дату по умолчанию
const today = new Date().toISOString().split("T")[0];
document.getElementById("date").value = today;

// Получаем дату начала недели (Понедельник)
function getWeekDates(startDate) {
  const start = new Date(startDate);
  const day = start.getDay();
  const monday = new Date(start);
  monday.setDate(start.getDate() - ((day + 6) % 7)); // Пн = 0
  const dates = [];
  for (let i = 0; i < 5; i++) {
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    dates.push(d.toISOString().split("T")[0]);
  }
  return dates;
}

// Получаем день недели по дате
function getWeekday(dateString) {
  const days = ["Воскресенье","Понедельник","Вторник","Среда","Четверг","Пятница","Суббота"];
  return days[new Date(dateString).getDay()];
}

// Загружаем данные с сервера
async function load() {
  const res = await fetch("/api/bookings");
  const data = await res.json();
  renderTable(data);
  renderMap(data);
}

// Кнопка бронирования
async function book() {
  const date = document.getElementById("date").value;
  if (!date) { alert("Выберите дату!"); return; }

  const weekBooking = document.getElementById("weekBooking").checked;
  let dates = weekBooking ? getWeekDates(date) : [date];

  const blockedDays = [];
  for (let d of dates) {
    const res = await fetch("/api/bookings", {
      method:"POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ seat: seat.value, employee: emp.value, day: d })
    });
    const data = await res.json();
    if (!res.ok) blockedDays.push(d);
  }

  if (blockedDays.length) {
    alert(`Следующие дни не забронированы, так как места заняты: ${blockedDays.join(", ")}`);
  } else {
    alert("Бронирование успешно!");
  }

  load();
}

// Удалить бронирование
function cancel(id) {
  fetch(`/api/bookings/${id}`, { method:"DELETE" })
    .then(() => load());
}

// Отобразить таблицу с записями
function renderTable(data) {
  const table = document.getElementById("table");
  table.innerHTML = "";
  data.forEach(b => {
    table.innerHTML += `<tr>
      <td>${b.seat}</td>
      <td>${b.employee}</td>
      <td>${b.day}</td>
      <td>${getWeekday(b.day)}</td>
      <td class="cancel" onclick="cancel(${b.id})">Отмена</td>
    </tr>`;
  });
}

// Отобразить карту с офисом
function renderMap(bookings) {
  const map = document.getElementById("office-map");
  map.innerHTML = "";

  const selectedDate = document.getElementById("date").value;
  if (!selectedDate) return;

  const weekDates = getWeekDates(selectedDate);
  const currentDay = new Date().toISOString().split("T")[0]; // Текущий день

  seats.forEach(s => {
    const seatBookings = bookings.filter(b => b.seat === s);

    const div = document.createElement("div");
    div.className = "seat";

    const nameDiv = document.createElement("div");
    nameDiv.className = "seat-name";
    nameDiv.innerText = s;
    div.appendChild(nameDiv);

    weekDates.forEach((dayStr, i) => {
      const b = seatBookings.find(bk => bk.day === dayStr);
      const dayDiv = document.createElement("div");
      dayDiv.className = "day-block " + (b ? "taken" : "available");

      // Подсвечиваем текущий день
      if (dayStr === currentDay) {
        dayDiv.classList.add("current-day");
      }

      dayDiv.innerText = WORK_DAYS[i][0];
      dayDiv.title = b ? `${dayStr} (${WORK_DAYS[i]}): ${b.employee}` 
                       : `${dayStr} (${WORK_DAYS[i]}): свободно`;
      div.appendChild(dayDiv);
    });

    div.onclick = () => {
      const info = seatBookings.map(b => `${b.day} (${getWeekday(b.day)}): ${b.employee}`).join("\n");
      alert(info || `Место ${s} свободно`);
    };

    map.appendChild(div);
  });
}

// Функция изменения недели (переход вперед или назад)
function changeWeek(direction) {
  const dateInput = document.getElementById("date");
  const currentDate = new Date(dateInput.value);
  currentDate.setDate(currentDate.getDate() + direction * 7); // Смещаем на 7 дней

  dateInput.value = currentDate.toISOString().split("T")[0]; // Устанавливаем новую дату
  load(); // Перезагружаем данные
}

// Загружаем данные при старте
load();
</script>

</body>
</html>
