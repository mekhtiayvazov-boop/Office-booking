<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Бронирование мест</title>
  <style>
    body { font-family: Arial; background:#f4f6f8; padding:30px; }
    select, input, button { padding:8px; width:300px; margin:5px 0; }
    table { margin-top:20px; width:100%; border-collapse:collapse; background:#fff; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
    th { background:#eee; }
    .cancel { color:red; cursor:pointer; }
    #office-map { display:grid; grid-template-columns:repeat(5,120px); grid-gap:10px; margin-top:20px; }
    .seat { border-radius:8px; display:flex; justify-content:space-between; flex-direction:column; cursor:pointer; user-select:none; padding:5px; background:#eaeaea; }
    .seat-name { text-align:center; font-weight:bold; margin-bottom:3px; }
    .day-block { flex:1; margin:1px 0; border-radius:4px; color:white; font-size:10px; display:flex; align-items:center; justify-content:center; transition: transform .1s; }
    .day-block.available { background:#28a745; }
    .day-block.taken { background:#dc3545; }
    .day-block.current-day { background:#ffc107; }
    .day-block:hover { transform: scale(1.1); }
    #week-nav { display: flex; justify-content: space-between; margin-bottom: 20px; }
    #week-nav button { padding: 10px; }
  </style>
</head>
<body>

<h2>Бронирование мест</h2>

<select id="employee" placeholder="Сотрудник"></select><br>
<select id="seat" placeholder="Место"></select><br>

<label>Выберите дату (Пн для недели):</label><br>
<input type="date" id="date"><br>

<label>
  <input type="checkbox" id="weekBooking"> Бронирование на всю неделю (Пн–Пт)
</label><br>

<button onclick="book()">Забронировать</button>

<h3>Фильтры</h3>
<input type="text" id="filterEmployee" placeholder="Фильтр по сотруднику">
<input type="text" id="filterSeat" placeholder="Фильтр по месту">
<input type="date" id="filterDay">
<button onclick="load()">Применить фильтры</button>
<button onclick="clearFilters()">Сбросить</button>

<h2>Текущая неделя</h2>
<div id="week-nav">
  <button onclick="changeWeek(-1)">◀ Пред. неделя</button>
  <button onclick="changeWeek(1)">След. неделя ▶</button>
</div>

<h2>Схема офиса</h2>
<div id="office-map"></div>

<table>
<thead>
  <tr>
    <th>Место</th>
    <th>Сотрудник</th>
    <th>Дата</th>
    <th>День недели</th>
    <th></th>
  </tr>
</thead>
<tbody id="table"></tbody>
</table>

<script>
// Список мест
const seats = ["4D26","4D27","4D28","4D31","4D32","4D33","4D34","4E29","4E30","4E32","4E33","4E34","4EX1","4EX2","4EX3"];
const WORK_DAYS = ["Понедельник", "Вторник", "Среда", "Четверг", "Пятница"];
const emp = document.getElementById("employee");
const seatElement = document.getElementById("seat");

// Получение списка сотрудников и мест
async function fetchEmployeeAndSeats() {
  const res = await fetch('/api/employee-seats');
  const data = await res.json();

  data.employees.forEach(e => emp.add(new Option(e, e)));
  seats.forEach(s => seatElement.add(new Option(s, s)));
}

// Установка текущей даты в поле ввода
const today = new Date().toISOString().split("T")[0];
document.getElementById("date").value = today;

// Получение дат текущей недели
function getWeekDates(startDate) {
  const start = new Date(startDate);
  const day = start.getDay();
  const monday = new Date(start);
  monday.setDate(start.getDate() - ((day + 6) % 7));
  const dates = [];
  for (let i = 0; i < 5; i++) {
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    dates.push(d.toISOString().split("T")[0]);
  }
  return dates;
}

// Получение дня недели
function getWeekday(dateString) {
  const days = ["Воскресенье", "Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота"];
  return days[new Date(dateString).getDay()];
}

// Загрузка и фильтрация данных
async function load() {
  const params = [];
  const empFilter = document.getElementById("filterEmployee").value;
  const seatFilter = document.getElementById("filterSeat").value;
  const dayFilter = document.getElementById("filterDay").value;

  let url = "/api/bookings?";
  if (empFilter) url += `employee=${encodeURIComponent(empFilter)}&`;
  if (seatFilter) url += `seat=${encodeURIComponent(seatFilter)}&`;
  if (dayFilter) url += `day=${encodeURIComponent(dayFilter)}&`;

  const res = await fetch(url);
  const data = await res.json();

  // Проверяем, есть ли данные
  if (data && data.length) {
    renderTable(data);
    renderMap(data);
  } else {
    alert("Нет данных для отображения.");
  }
}

// Очистка фильтров
function clearFilters() {
  document.getElementById("filterEmployee").value = "";
  document.getElementById("filterSeat").value = "";
  document.getElementById("filterDay").value = "";
  load();
}

// Бронирование места
async function book() {
  const date = document.getElementById("date").value;
  if (!date) { alert("Выберите дату!"); return; }

  const weekBooking = document.getElementById("weekBooking").checked;
  let dates = weekBooking ? getWeekDates(date) : [date];

  const blockedDays = [];
  for (let d of dates) {
    const res = await fetch("/api/bookings", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ seat: seatElement.value, employee: emp.value, day: d })
    });
    const data = await res.json();
    if (!res.ok) blockedDays.push(d);
  }

  if (blockedDays.length) {
    alert(`Следующие дни не забронированы, так как места заняты: ${blockedDays.join(", ")}`);
  } else {
    alert("Бронирование успешно!");
  }

  load();
}

// Отмена бронирования
function cancel(id) {
  fetch(`/api/bookings/${id}`, { method: "DELETE" }).then(() => load());
}

// Отображение таблицы бронирований
function renderTable(data) {
  const table = document.getElementById("table");
  table.innerHTML = "";
  data.forEach(b => {
    table.innerHTML += `<tr>
      <td>${b.seat}</td>
      <td>${b.employee}</td>
      <td>${b.day}</td>
      <td>${getWeekday(b.day)}</td>
      <td class="cancel" onclick="cancel(${b.id})">Отмена</td>
    </tr>`;
  });
}

// Отображение карты офиса
function renderMap(bookings) {
  const map = document.getElementById("office-map");
  map.innerHTML = "";

  const selectedDate = document.getElementById("date").value;
  if (!selectedDate) return;

  const weekDates = getWeekDates(selectedDate);
  const currentDay = new Date().toISOString().split("T")[0]; // Убираем время

  seats.forEach(s => {
    const seatBookings = bookings.filter(b => b.seat === s);
    const div = document.createElement("div");
    div.className = "seat";

    const nameDiv = document.createElement("div");
    nameDiv.className = "seat-name";
    nameDiv.innerText = s;
    div.appendChild(nameDiv);

    weekDates.forEach((dayStr, i) => {
      const b = seatBookings.find(bk => bk.day === dayStr);
      const dayDiv = document.createElement("div");
      dayDiv.className = "day-block";

      if (b) {
        dayDiv.classList.add("taken");
      } else if (dayStr === currentDay) {
        dayDiv.classList.add("current-day");
      } else {
        dayDiv.classList.add("available");
      }

      dayDiv.innerText = WORK_DAYS[i];
      div.appendChild(dayDiv);
    });

    map.appendChild(div);
  });
}

// Изменение недели
function changeWeek(direction) {
  const dateInput = document.getElementById("date");
  const currentDate = new Date(dateInput.value);
  currentDate.setDate(currentDate.getDate() + direction * 7);
  dateInput.value = currentDate.toISOString().split("T")[0];
  load();
}

// Стартовая загрузка данных
fetchEmployeeAndSeats().then(load);
</script>

</body>
</html>
